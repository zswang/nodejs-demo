var application=application||{};application.Classes=application.Classes||{};application.Core=(function(){var n={};var h={};var c={};var u=[];var e=window.baidu||window.jQuery;var d;function k(){}function x(z){var i=this;this.format=function(A){return q("(#{0}) #{1}",[i.id,A])};this.level=0;this.id=z}x.prototype._getLogger=function(){return x};x.prototype.setLevel=function(i){this.level=i;return this};x.LOG_LEVELS=["debug","log","info","warn","error","fatal","logg"];var p=x.LOG_LEVELS.length;while(p--){x.prototype[x.LOG_LEVELS[p]]=k}var y=w("Core");function w(i){if(!c[i]){c[i]=new x()}return c[i]}function q(z,i){return z.replace(/#\{(.*?)\}/g,function(B,A){return i&&(A in i)?i[A]:""})}function v(){return e}var r={module:function(i){return{getLib:v,getLogger:function(){return w(i)},getConfig:function(z){return t(z||i)},getExtension:m,on:f,un:j,notify:g}},extension:function(i){return{getLib:v,getLogger:function(){return w(i)},getConfig:function(z){return t(z||i)},getExtension:m}}};var l={module:{},extension:{}};function f(B,A){if(!B){y.fatal("on(!, ?) 'event' Parameters can't for empty.");return}if(typeof A!="function"){y.fatal(q("on('#{0}', !) 'handler' Parameters must be function types.",[B]));return}if(B instanceof Array){var z=B.length;while(z--){f(B[z],A)}return}n[B]=n[B]||[];n[B].unshift(A)}function j(B,A){if(!B){y.fatal("un(!,?) 'event' Parameters can't for empty.");return}if(typeof A!="function"){y.fatal(q("un('#{0}', !) 'handler' Parameters must be function types.",[B]));return}if(B instanceof Array){var z=B.length;while(z--){j(B[z],A)}return}var C=n[B],z;if(!C){return}z=C.length;while(z--){if(C[z]===A){C.splice(z,1)}}}function g(A,C){if(!d){u.push([A,C]);return}var B=n[A],z;if(!B){return}z=B.length;while(z--){setTimeout((function(i){return function(){try{i(C,A)}catch(D){y.error(q("event:#{0} message:#{1}",[A,D.message]))}}})(B[z]),0)}}function a(z,A,i){if(!A){y.fatal(q("register('#{0}', !, ?) 'id' Parameters must be exists.",[z]));return}if(typeof i!="function"){y.fatal(q("register('#{0}', '#{1}', !) 'creator' Parameters must be function types.",[z,A]));return}if(l[z][A]){y.fatal(q("register('#{0}', '#{1}', ?) #{0} '#{1}' was already exists.",[z,A]));return}y.log(q("Register #{0} '#{1}'.",[z,A]));return l[z][A]={creator:i,instance:null}}function b(i,A){var z=l[i][A];if(!z||z.instance){return}z.instance=z.creator(r[i](A));if(z.instance.init){z.instance.init()}}function o(i,A){var z=l[i][A];if(!z||!z.instance){return}if(z.instance.destroy){z.instance.destroy()}z.instance=null}function s(){if(d){y.fatal("startAll() Program has begun.");return}var z,i;for(z in l.plugin){b("plugin",z)}for(z in l.module){b("module",z)}d=true;g("Core-StartAll",{});while(i=u.shift()){g(i[0],i[1])}y.info("Start all modules ... done!")}function m(z){var i=l.extension[z];if(i){return i.instance}y.fatal(q("getExtension(!) Extension '#{0}' is missing.",[z]))}function t(z){var i=h[z];if(i){return i}y.warn(q("Config '#{0}' not found.",[z]))}function w(i){if(!c[i]){c[i]=new x(i)}return c[i]}e.on(window,"load",function(){s()});return{registerModule:function(z,i){a("module",z,i);if(d){b("module",z)}},registerExtension:function(z,i){a("extension",z,i);b("extension",z)},addConfig:function(B,i){i=i||{};var A,z;if(B){if(h[B]){y.warn(q("Config '#{0}' was already exists.",[B]))}A=h[B]=h[B]||{};for(z in i){A[z]=i[z]}}else{for(z in i){h[z]=i[z]}}}}})();var AceTemplate=AceTemplate||{};(function(){var e={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};var c={'"':"quot","<":"lt",">":"gt","&":"amp"," ":"nbsp"};var f={g:function(g){if(typeof g!="string"){return g}return document.getElementById(g)},decodeHTML:function(g){return String(g).replace(/&(quot|lt|gt|amp|nbsp);/ig,function(i,h){return e[h]}).replace(/&#u([a-f\d]{4});/ig,function(h,i){return String.fromCharCode(parseInt("0x"+i))}).replace(/&#(\d+);/ig,function(h,i){return String.fromCharCode(+i)})},encodeHTML:function(g){return String(g).replace(/["<>& ]/g,function(h){return"&"+c[h]+";"})},elementText:function(g){if(!g||!g.tagName){return""}if(/^(input|textarea)$/i.test(g.tagName)){return g.value}return f.decodeHTML(g.innerHTML)}};var a={};var d=false;function b(i){var h=[],j=[];h.push("with(this){");h.push(i.replace(/[\r\n]+/g,"\n").replace(/^\n+|\s+$/mg,"").replace(/((^\s*[<>!#^&\u0000-\u0008\u007F-\uffff].*$|^.*[<>]\s*$|^(?!\s*(else|do|try|finally)\s*$)[^'":;,\[\]{}()\n\/]+$|^(\s*(([\w-]+\s*=\s*"[^"]*")|([\w-]+\s*=\s*'[^']*')))+\s*$|^\s*([.#][\w-.]+(:\w+)?(\s*|,))*(?!(else|do|while|try|return)\b)[.#]?[\w-.*]+(:\w+)?\s*\{.*$)\s?)+/mg,function(k){k=['"',k.replace(/&none;/g,"").replace(/["'\\]/g,"\\$&").replace(/\n/g,"\\n").replace(/(!?#)\{(.*?)\}/g,function(o,l,n){n=n.replace(/\\n/g,"\n").replace(/\\([\\'"])/g,"$1");var m=/^[a-z$][\w+$]+$/i.test(n)&&!(/^(true|false|NaN|null|this)$/.test(n));return['",',m?["typeof ",n,'=="undefined"?"":'].join(""):"",(l=="#"?"_encode_":""),"(",n,'),"'].join("")}),'"'].join("").replace(/^"",|,""$/g,"");if(k){return["_output_.push(",k,");"].join("")}else{return""}}));h.push("}");var g=new Function("_output_","_encode_","helper",h.join(""));return g}AceTemplate.format=function(l,k,j){if(!l){return""}var g,i;if(typeof l=="object"&&l.tagName){i=l;l=i.getAttribute("id")}j=j||this;g=a[l];if(!g){if(!/[^\w-]/.test(l)){if(!i){i=f.g(l)}g=this.register(l,i)}else{g=b(l)}}var h=[];g.call(k||"",h,f.encodeHTML,j);return h.join("")};AceTemplate.register=function(l,k){if(!arguments.length&&!d){d=true;var g=document.getElementsByTagName("script");for(var j=0;j<g.length;j++){var h=g[j];if(/^(text\/template)$/i.test(h.getAttribute("type"))){var l=h.getAttribute("id");l&&arguments.callee.call(this,l,h)}}}if(!l){return}if(a[l]){return a[l]}if(typeof k!="string"){if(typeof k=="undefined"){k=f.g(l)}k=f.elementText(k)}return a[l]=b(k)};AceTemplate.unregister=function(g){delete a[g]}})();var AceEvent=AceEvent||{};(function(){var e={g:function(f){if(typeof f!="string"){return f}return document.getElementById(f)},on:function(g,f,h){g=e.g(g);if(!g){return}if(g.addEventListener){g.addEventListener(f,h,false)}else{g.attachEvent&&g.attachEvent("on"+f,h)}},un:function(g,f,h){g=e.g(g);if(!g){return}if(g.removeEventListener){g.removeEventListener(f,h,false)}else{g.detachEvent&&g.detachEvent("on"+f,h)}},each:function(f,g){if(!f||!g){return}for(var h=0;h<f.length;h++){if(g(f[h],h)===false){return}}}};var d={};var a=["mousedown","click","dblclick"];var b=0;function c(g,f){if(!g||!f){return}while(g&&!/^html$/i.test(g.tagName)){if(f(g)==false){return}g=g.parentNode}}AceEvent.on=function(g,i,f){if(!i){return}g=e.g(g);if(!g){return}f=f||a;if(!(f instanceof Array)){f=[f]}if(!f.length){return}b++;var h=d[b]={target:g,events:{},callback:i};e.each(f,function(j){if(h.events[j]){return}h.events[j]=function(l){l=l||event;var k=l.srcElement||l.target;if(/^(html|document)$/i.test(k.tagName)){k=document.body}c(k,function(m){if(g.parentNode==m){return false}if(!m.getAttribute){return}var n=m.getAttribute("event-"+j);if(!n){switch(j){case"click":n=m.getAttribute("cmd");break;case"mousedown":n=m.getAttribute("down");break;case"contextmenu":n=m.getAttribute("menu");break}}if(!n){return}i(n,m,l);return false})};e.on(g,j,h.events[j])});return b};AceEvent.fire=function(h,j,f,i){var g=d[h];g&&g.callback(j,f,i)};AceEvent.un=function(h){var g=d[h];if(!g){return}for(var f in g.events){e.un(g.target,f,g.events[f])}delete d[h]}})();var AceTree=AceTree||{};(function(){var i={g:function(n){if(typeof n!="string"){return n}return document.getElementById(n)},remove:function(n){n=this.g(n);if(!n){return}n.parentNode.removeChild(n)},addClass:function(n,o){g(n,"class",o)},removeClass:function(n,o){h(n,"class",o)},each:function(p,o){if(!p||!o){return}for(var n=0;n<p.length;n++){if(o(p[n],n)===false){break}}},getKeys:function(q){var n=[];for(var o in q){n.push(o)}return n}};function a(o,p){o=i.g(o);p=i.g(p);if(o==p){return true}var n;d(p,function(q){if(o==q){n=false;return false}});return n}function b(o,n){o=i.g(o);if(!o){return}o.removeAttribute("id");o.parentNode.insertBefore(e(n),o);o.parentNode.removeChild(o)}function g(p,o,r){p=i.g(p);if(!p||!p.getAttribute||!p.setAttribute){return}var q=p.getAttribute(o);if(q){var n=q.indexOf(r);while(n>=0){if(/^\s*$/.test(q.charAt(n-1)+q.charAt(n+r.length))){return}n=q.indexOf(r,n+1)}q+=" "+r}else{q=r}p.setAttribute(o,q)}function h(p,o,r){p=i.g(p);if(!p||!p.getAttribute||!p.setAttribute){return}var q=p.getAttribute(o);if(!q){return}var n=q.indexOf(r);while(n>=0){if(/^\s*$/.test(q.charAt(n-1)+q.charAt(n+r.length))){p.setAttribute(o,q.substring(0,n)+q.substring(n+r.length));return}n=q.indexOf(r,n+1)}}function d(o,n){o=i.g(o);if(!o||!n){return}while(o&&!/^html$/i.test(o.tagName)){if(n(o)==false){return}o=o.parentNode}}var m={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]};m.optgroup=m.option;m.tbody=m.tfoot=m.colgroup=m.caption=m.thead;m.th=m.td;function e(q){var o=document.createDocumentFragment();if(!q){return o}q=q.replace(/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,"<$1></$2>");var n=(q.match(/<([\w:]+)/)||["",""])[1].toLowerCase(),r=m[n]||m._default,p=r[0],s=document.createElement("div");s.innerHTML=[r[1],q,r[2]].join("");while(p--){s=s.lastChild}while(s.childNodes.length){o.appendChild(s.childNodes[0])}return o}var l={};var k=0;function j(n,o){this.parentNode=n;this.tree=n.tree;this.layer=n.layer+1;this.id=o[this.tree.fieldIdentifier];this.did=[this.tree.didPrefix,this.tree.handler,this.id].join("-");this.cid=[this.tree.didPrefix,this.tree.handler,this.id,"childs"].join("-");l[this.did]=this;this.data=o;this.status={};this.childNodes=[];if(this.tree.oncreated){this.tree.oncreated(this)}}j.prototype.remove=function(o){if(this.tree.focusDid==this.did){this.tree.focusDid=""}this.removeAll(true);delete l[this.did];if(o){return}this.parentNode.childNodes=[].concat(this.parentNode.childNodes.slice(0,this.index),this.parentNode.childNodes.slice(this.index+1));for(var n=this.index;n<this.parentNode.childNodes.length;n++){this.parentNode.childNodes[n].index=n}this.parentNode.refresh()};j.prototype.appendChild=function(o,p){if(!o){return}if(typeof p=="undefined"){p=true}var n=new j(this,o);n.index=this.childNodes.length;this.childNodes.push(n);if(p){n.loadChilds(o[this.tree.fieldChilds],true)}this.tree.onsort&&this.childNodes.sort(this.tree.onsort);this.refresh();return n};j.prototype.appendChilds=function(n,q){if(!n){return}if(typeof q=="undefined"){q=true}var p=this;var o=[];i.each(n,function(s){var r=new j(p,s);o.push(r);r.index=p.childNodes.length;p.childNodes.push(r);if(q){r.loadChilds(s[p.tree.fieldChilds],true)}});this.tree.onsort&&this.childNodes.sort(this.tree.onsort);this.refresh();return o};j.prototype.sort=function(p,o){if(!this.tree.onsort){return}this.childNodes.sort(this.tree.onsort);var n;i.each(this.childNodes,function(r,q){if(r.index!=q){r.index=q;n=true}if(p&&r.sort(true,true)){n=true}});if(n&&!o){this.refresh()}return n};j.prototype.updateData=function(n,r){if(!n){return}var q=false;for(var o in n){if(this.data[o]!==n[o]){this.data[o]=n[o];q=true}}if(r){this.loadChilds(n[this.tree.fieldChilds],true)}if(q||r){this.tree.onsort&&this.parentNode.childNodes.sort(this.tree.onsort);this.parentNode.refresh()}};j.prototype.reader=function(){if(!this.tree.onreader){return""}var o=[];i.each(this.childNodes,function(p){o.push(p.reader())});if(this==this.tree){return o.join("")}var n=this;return this.tree.onreader(this).replace(/(^\s*<\w+)([^>]*>)([\s\S]*$)/,function(q,p,s,r){r=r.replace(/(<\w+\b[^>]*)(\bdata-type="childs"[^>]*>)(\s*<\/\w+>)/,function(u,t,w,v){if(!o.length){return""}return[t,' id="',n.cid,'"',w,o.join(""),v].join("")});return[p,' id="',n.did,'"',s,r].join("")})};j.prototype.removeAll=function(n){i.each(this.childNodes,function(o){o.remove(true)});this.childNodes=[];if(n){return}this.refresh()};j.prototype.loadChilds=function(n,p){if(this.childNodes.length==0&&n&&n.length==0){return}this.removeAll(true);if(!n){return}var o=this;i.each(n,function(r){var q=new j(o,r);o.childNodes.push(q);q.loadChilds(r[o.tree.fieldChilds],true)});this.tree.onsort&&this.childNodes.sort(this.tree.onsort);i.each(this.childNodes,function(r,q){r.index=q});!p&&this.refresh()};j.prototype.each=function(o){var n;o&&i.each(this.childNodes,function(p){result=o(p)||p.each(o);if(n===false){return n}});return n};j.prototype.setStatus=function(n,o,p){if(!n){return}if(this.status[n]==o){return}this.status[n]=o;if(p){return}if(this.tree.statusClasses.test(n)){if(o){i.addClass(this.did,n);this.tree.childsClasses.test(n)&&i.addClass(this.cid,n)}else{i.removeClass(this.did,n);this.tree.childsClasses.test(n)&&i.removeClass(this.cid,n)}}else{this.refresh()}};j.prototype.getStatus=function(n){return this.status[n]};j.prototype.getClasses=function(o){var n=[];for(var q in this.status){if(!this.tree.statusClasses.test(q)){continue}if(this.status[q]&&(!o||this.tree.childsClasses.test(q))){n.push(q)}}return n.join(" ")};j.prototype.refresh=function(){if(this==this.tree){this.parent.innerHTML=j.prototype.reader.call(this);return}!a(this.did,this.cid)&&i.remove(this.cid);b(this.did,this.reader())};j.prototype.expand=function(){this.setStatus("expand",true)};j.prototype.collapse=function(){this.setStatus("expand",false)};j.prototype.toggle=function(){this.setStatus("expand",!this.getStatus("expand"))};j.prototype.nextNode=function(){if(this.childNodes.length&&this.getStatus("expand")){return this.childNodes[0]}return this.parentNode.childNodes[this.index+1]};j.prototype.previousNode=function(){if(!this.index){if(this.parentNode==this.tree){return}return this.parentNode}return this.parentNode.childNodes[this.index-1]};j.prototype.focus=function(n){this.tree.setFocused(this,n)};var c={didPrefix:"node",fieldIdentifier:"id",fieldChilds:"nodes",statusClasses:/^(focus|hover|select|expand)$/,childsClasses:/^(expand)$/};function f(n){n=n||{};for(var o in c){!(o in n)&&(n[o]=c[o])}for(var o in n){this[o]=n[o]}this.tree=this;this.layer=0;this.index=0;this.handler=k++;this.childNodes=[];this.focusDid="";g(this.parent,"data-handler",this.handler);if(this.oninit){this.oninit(this)}}f.prototype.loadChilds=function(n,o){if(this.childNodes.length==0&&n&&n.length==0){return}o&&this.saveStatus();j.prototype.loadChilds.call(this,n,true);o&&this.restoreStatus();this.refresh()};f.prototype.appendChild=function(n,o){return j.prototype.appendChild.call(this,n,o)};f.prototype.appendChilds=function(n,o){return j.prototype.appendChilds.call(this,n,o)};f.prototype.updateData=function(o,p){if(!o){return}var n=this.node4data(o);n&&n.updateData(o,p);return n};f.prototype.sort=function(n){j.prototype.sort.call(this,true,n||typeof n=="undefiend")};f.prototype.refresh=function(){j.prototype.refresh.call(this)};f.prototype.removeAll=function(){if(!this.childNodes.length){return}j.prototype.removeAll.call(this);this.refresh()};f.prototype.removeNode=function(o){if(!o){return}var n=this.node4data(o);n&&n.remove()};f.prototype.setFocused=function(p,n){if(!p){return}var o=this.node4data(p);if(!o||o.did==this.focusDid){return}var q=l[this.focusDid];q&&q.setStatus("focus",false);o&&o.setStatus("focus",true);if(n){var r=i.g(o.did);r&&r.scrollIntoView(n==1)}this.focusDid=o.did;if(this.onfocus){this.onfocus(o)}};f.prototype.getFocused=function(){return l[this.focusDid]};f.prototype.node4data=function(o){if(!o){return}if(o instanceof j&&o.tree==this){return o}var p=typeof o=="string"?o:o[this.fieldIdentifier];var n=[this.didPrefix,this.handler,p].join("-");if(l[n]){return l[n]}};f.prototype.node4target=function(o){var n=AceTree.node4target(o);if(!n||n.tree!=this){return}return n};f.prototype.each=function(n){return j.prototype.each.call(this,n)};f.prototype.saveStatus=function(){var n={};this.status=n;this.each(function(o){n[o.did]=o.status})};f.prototype.restoreStatus=function(){if(!this.status){return}var n=this.status;this.each(function(o){if(o.did in n){o.status=n[o.did]}});this.status=null};AceTree.create=function(n){return new f(n)};AceTree.node4target=function(o){var n;o=i.g(o);d(o,function(p){var q=l[p.id];if(q){n=q;return false}});return n}})();application.Core.addConfig("ChatApi",{pickMaxWait:45*1000,pickUrl:"http://localhost:2012/pick",commandUrl:"http://localhost:2012/command"});application.Core.registerExtension("ChatApi",function(a){var d=a.getLib();var c=a.getLogger();var b=a.getConfig();return{pick:function(f,h){if(!f||!h){return}var g=setTimeout(function(){g=0;h({result:"overtime"});h=function(){}},b.pickMaxWait);var e=[b.pickUrl,d.url.jsonToQuery(f)].join("?");c.log(e);d.sio.callByServer(e,function(i){g&&clearTimeout(g);g=0;h(i)})},command:function(f,g){if(!f){return}var e=[b.commandUrl,d.url.jsonToQuery(f)].join("?");c.log(e);d.sio.callByServer(e,function(h){g&&g(h)})}}});application.Core.addConfig("Events",{pickSuccess:1});application.Core.registerModule("Manager",function(a){var d=a.getConfig("Events");var f=a.getLib();var c=a.getLogger();var e=a.getExtension("ChatApi");var b=0;function g(){e.pick({seq:b},function(h){if(!h||h.result!="ok"){if(h&&h.result!="kill"){g()}c.log("pick error.");return}if(b!=h.currSeq){return}if("nextSeq" in h){b=h.nextSeq;c.log("seq change to:"+b)}if("fields" in h){a.notify(d.pickSuccess,h.fields)}g()})}return{init:function(){AceTemplate.register();e.command({command:"enter"},function(h){if(!h||h.result!="ok"){c.log("enter channel error.");return}g()})}}});application.Core.registerModule("MessageBox",function(e){var h=e.getConfig("Events");var c=e.getLib();var f=e.getLogger();var d;var a={};function i(j){c.each(j,function(k){switch(k.type){case"passport":a=k.info;break;case"messageAll":d.loadChilds(k.messages);break;case"messageAdd":d.appendChilds(k.messages);break}})}function g(k){var l=c.date.format(k,"HH:mm:ss");var j=c.date.format(k,"yyyy:MM:dd");return c.date.format(new Date,"yyyy:MM:dd")==j?l:[j,l].join(" ")}function b(j){return j==a.id?"self":""}return{init:function(){d=AceTree.create({parent:c.g("messageListTemplate").parentNode,oninit:function(j){j.eventHandler=AceEvent.on(j.parent,function(n,k,m){var l=j.node4target(k);l&&j.oncommand(n,l,m)})},onreader:function(j){return AceTemplate.format("messageListTemplate",j.data,{node:j,formatTime:g,ifSelf:b})},oncommand:function(l,j,k){switch(l){}}});e.on(h.pickSuccess,i)}}});application.Core.registerModule("PlayerBox",function(a){var d=a.getConfig("Events");var f=a.getLib();var c;var g={};function e(h){f.each(h,function(i){switch(i.type){case"passport":g=i.info;break;case"playerAll":c.loadChilds(i.players);break;case"playerAdd":c.appendChilds(i.players);break;case"playerUpdate":f.each(i.players,function(j){c.updateData(j)});break;case"playerRemove":f.each(i.players,function(j){c.removeNode(j)});break}})}function b(h){return h==g.id?"self":""}return{init:function(){c=AceTree.create({parent:f.g("playerListTemplate").parentNode,oninit:function(h){AceEvent.on(h.parent,function(l,k,j){var i=h.node4target(k);i&&h.oncommand(l,i,j)})},onreader:function(h){return AceTemplate.format("playerListTemplate",h.data,{node:h,ifSelf:b})},oncommand:function(j,h,i){switch(j){}}});a.on(d.pickSuccess,e)}}});application.Core.registerModule("EditorBox",function(a){var c=a.getConfig("Events");var e=a.getLib();var b=a.getLogger();var d=a.getExtension("ChatApi");return{init:function(){var f=AceEvent.on("tools",function(j,g,h){switch(j){case"send":var i=e.g("editor").value;if(!i){return}d.command({command:"talk",text:i},function(k){if(!k||k.result!="ok"){return}e.g("editor").value=""});break}});e.on("editor","keydown",function(g){switch(g.which||g.keyCode||g.charCode){case 13:if(!g.ctrlKey){e.event.stop(g);AceEvent.fire(f,"send")}break}})}}});